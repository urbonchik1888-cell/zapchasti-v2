<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç GitHub API</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .result { margin: 10px 0; padding: 10px; background: #f5f5f5; border-radius: 3px; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e8; color: #2e7d32; }
    </style>
</head>
<body>
    <h1>üîß –¢–µ—Å—Ç GitHub API</h1>
    
    <div class="test-section">
        <h3>1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞</h3>
        <input type="text" id="tokenInput" placeholder="–í–≤–µ–¥–∏—Ç–µ GitHub —Ç–æ–∫–µ–Ω" style="width: 300px; padding: 5px;">
        <button onclick="testToken()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–∫–µ–Ω</button>
        <div id="tokenResult" class="result"></div>
        <p><small>–ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, <a href="https://github.com/settings/tokens/new" target="_blank">—Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω</a> —Å –ø—Ä–∞–≤–æ–º <strong>repo</strong></small></p>
    </div>
    
    <div class="test-section">
        <h3>2. –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö</h3>
        <button onclick="testRead()">–ü—Ä–æ—á–∏—Ç–∞—Ç—å data.json</button>
        <div id="readResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>3. –ó–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö</h3>
        <button onclick="testWrite()">–ó–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ</button>
        <div id="writeResult" class="result"></div>
    </div>

    <script>
        async function testToken() {
            const token = document.getElementById('tokenInput').value.trim();
            const resultDiv = document.getElementById('tokenResult');
            
            if (!token) {
                resultDiv.innerHTML = '<div class="error">–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω</div>';
                return;
            }
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–∑–æ–≤—ã–µ –ø—Ä–∞–≤–∞
                const userResponse = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': 'token ' + token,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!userResponse.ok) {
                    const error = await userResponse.text();
                    resultDiv.innerHTML = `<div class="error">‚ùå –¢–æ–∫–µ–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω: ${error}</div>`;
                    return;
                }
                
                const user = await userResponse.json();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
                const repoResponse = await fetch('https://api.github.com/repos/urbonchik1888-cell/zapchasti-v2', {
                    headers: {
                        'Authorization': 'token ' + token,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                let repoInfo = '';
                if (repoResponse.ok) {
                    const repo = await repoResponse.json();
                    repoInfo = `<br>‚úÖ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–æ—Å—Ç—É–ø–µ–Ω: ${repo.full_name}`;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞ data.json
                    const fileResponse = await fetch('https://api.github.com/repos/urbonchik1888-cell/zapchasti-v2/contents/data.json', {
                        headers: {
                            'Authorization': 'token ' + token,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (fileResponse.ok) {
                        const file = await fileResponse.json();
                        repoInfo += `<br>üìÅ –§–∞–π–ª data.json: —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (${file.size} –±–∞–π—Ç)`;
                    } else {
                        repoInfo += `<br>‚ùå –§–∞–π–ª data.json: –Ω–µ –Ω–∞–π–¥–µ–Ω`;
                    }
                } else {
                    repoInfo = `<br>‚ùå –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: ${await repoResponse.text()}`;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –∑–∞–ø–∏—Å—å
                const writeTest = await fetch('https://api.github.com/repos/urbonchik1888-cell/zapchasti/contents/data.json', {
                    method: 'GET',
                    headers: {
                        'Authorization': 'token ' + token,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                let writeInfo = '';
                if (writeTest.ok) {
                    writeInfo = '<br>‚úÖ –ü—Ä–∞–≤–∞ –Ω–∞ —á—Ç–µ–Ω–∏–µ –µ—Å—Ç—å';
                } else {
                    writeInfo = '<br>‚ùå –ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —á—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞';
                }
                
                resultDiv.innerHTML = `
                    <div class="success">‚úÖ –¢–æ–∫–µ–Ω –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${user.login}</div>
                    <div class="result">${repoInfo}${writeInfo}</div>
                `;
                
                localStorage.setItem('githubToken', token);
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
            }
        }
        
        async function testRead() {
            const token = localStorage.getItem('githubToken');
            const resultDiv = document.getElementById('readResult');
            
            if (!token) {
                resultDiv.innerHTML = '<div class="error">–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω</div>';
                return;
            }
            
            try {
                const response = await fetch('https://api.github.com/repos/urbonchik1888-cell/zapchasti-v2/contents/data.json', {
                    headers: {
                        'Authorization': 'token ' + token,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    resultDiv.innerHTML = `<div class="success">‚úÖ –§–∞–π–ª –Ω–∞–π–¥–µ–Ω. SHA: ${data.sha.substring(0, 7)}...</div>`;
                } else {
                    const error = await response.text();
                    resultDiv.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è: ${error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
            }
        }
        
        async function testWrite() {
            const token = localStorage.getItem('githubToken');
            const resultDiv = document.getElementById('writeResult');
            
            if (!token) {
                resultDiv.innerHTML = '<div class="error">–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω</div>';
                return;
            }
            
            try {
                resultDiv.innerHTML = '<div class="result">‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –Ω–∞ –∑–∞–ø–∏—Å—å...</div>';
                
                // –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Ñ–∞–π–ª
                const getResponse = await fetch('https://api.github.com/repos/urbonchik1888-cell/zapchasti-v2/contents/data.json', {
                    headers: {
                        'Authorization': 'token ' + token,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                let sha = null;
                let currentData = { newParts: [], usedParts: [], appliances: [], users: [] };
                
                if (getResponse.ok) {
                    const fileData = await getResponse.json();
                    sha = fileData.sha;
                    resultDiv.innerHTML = '<div class="result">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—É—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö...</div>';
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ
                    try {
                        const rawResponse = await fetch('https://raw.githubusercontent.com/urbonchik1888-cell/zapchasti-v2/main/data.json?t=' + Date.now());
                        if (rawResponse.ok) {
                            currentData = await rawResponse.json();
                            resultDiv.innerHTML = '<div class="result">‚è≥ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –∑–∞–ø–∏—Å–∏...</div>';
                        }
                    } catch (e) {
                        console.log('Using default data');
                    }
                } else {
                    const error = await getResponse.text();
                    resultDiv.innerHTML = `<div class="error">‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª—É: ${error}</div>`;
                    return;
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—É—é –∑–∞–ø–∏—Å—å —Å —Ç–µ–∫—É—â–∏–º –≤—Ä–µ–º–µ–Ω–µ–º
                const testEntry = {
                    timestamp: new Date().toISOString(),
                    device: navigator.userAgent.includes('iPhone') ? 'iPhone' : 'MacBook',
                    message: 'Test entry from GitHub API test page',
                    testId: Math.random().toString(36).substring(7)
                };
                
                if (!currentData.testEntries) {
                    currentData.testEntries = [];
                }
                currentData.testEntries.push(testEntry);
                
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(currentData, null, 2))));
                const body = {
                    message: `Test update from ${testEntry.device} at ${testEntry.timestamp}`,
                    content,
                    ...(sha && { sha })
                };
                
                resultDiv.innerHTML = '<div class="result">‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ GitHub...</div>';
                
                const putResponse = await fetch('https://api.github.com/repos/urbonchik1888-cell/zapchasti-v2/contents/data.json', {
                    method: 'PUT',
                    headers: {
                        'Authorization': 'token ' + token,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });
                
                if (putResponse.ok) {
                    const result = await putResponse.json();
                    resultDiv.innerHTML = `
                        <div class="success">‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!</div>
                        <div class="result">
                            Commit: ${result.commit.sha.substring(0, 7)}...<br>
                            –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: ${testEntry.device}<br>
                            –í—Ä–µ–º—è: ${testEntry.timestamp}<br>
                            <a href="https://github.com/urbonchik1888-cell/zapchasti-v2/commit/${result.commit.sha}" target="_blank">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ GitHub</a>
                        </div>
                    `;
                } else {
                    const error = await putResponse.text();
                    resultDiv.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏: ${error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>
